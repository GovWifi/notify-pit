name: CI

on:
    push:
        branches: ["main"]
    pull_request:
        branches: ["main"]

# Permissions are required to allow the action to comment on the PR
permissions:
    contents: read
    pull-requests: write

jobs:
    test:
        runs-on: ubuntu-latest

        # FIX: Tell the runner to execute 'run' steps inside the 'notify_pit' subdirectory
        defaults:
            run:
                working-directory: ./notify_pit

        steps:
            - uses: actions/checkout@v4

            # Runs 'make test' inside ./notify_pit
            - name: Build and Test
              run: make test

            # Posts the coverage report as a comment on the Pull Request
            - name: Post Coverage Comment
              if: success()
              uses: MishaKav/pytest-coverage-comment@main
              with:
                  # Points to the XML file generated by 'make test'
                  # Note: We must include the 'notify_pit/' prefix here because
                  # this action looks from the root of the repository.
                  pytest-xml-coverage-path: notify_pit/app/coverage.xml
                  title: "Coverage Report"
                  badge-title: "Coverage"
                  hide-comment: false
                  create-new-comment: false
                  report-only-changed-files: true
