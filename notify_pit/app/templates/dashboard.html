<!DOCTYPE html>
<html lang="en" class="govuk-template ">
  <head>
    <meta charset="utf-8">
    <title>Notify.pit Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="theme-color" content="#0b0c0c">
    <link href="{{ url_for('static', path='govuk-frontend-5.13.0.min.css') }}" rel="stylesheet">
    <style>
      .govuk-table__header button {
        background: none;
        border: none;
        color: inherit;
        font: inherit;
        cursor: pointer;
        padding: 0;
        text-align: left;
        display: flex;
        align-items: center;
      }
      .govuk-table__header button:hover {
        text-decoration: underline;
      }
      .govuk-table__header button::after {
        content: " \25BC"; /* Down arrow */
        font-size: 0.7em;
        margin-left: 5px;
        opacity: 0.3;
      }
      .govuk-table__header[aria-sort="ascending"] button::after {
        content: " \25B2"; /* Up arrow */
        opacity: 1;
      }
      .govuk-table__header[aria-sort="descending"] button::after {
        content: " \25BC"; /* Down arrow */
        opacity: 1;
      }
      .filter-container {
        background-color: #f3f2f1;
        padding: 20px;
        margin-bottom: 30px;
        border-bottom: 1px solid #b1b4b6;
      }
      /* Modal Styles */
      dialog {
        border: 5px solid #0b0c0c;
        padding: 0;
        width: 80%;
        max-width: 800px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      }
      dialog::backdrop {
        background: rgba(0, 0, 0, 0.6);
      }
      .modal-header {
        background-color: #f3f2f1;
        padding: 15px 20px;
        border-bottom: 1px solid #b1b4b6;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .modal-body {
        padding: 20px;
        background-color: #fff;
        overflow: auto;
        max-height: 70vh;
      }
      .json-view {
        font-family: monospace;
        white-space: pre-wrap;
        background: #f8f8f8;
        padding: 15px;
        border: 1px solid #b1b4b6;
        font-size: 14px;
      }
    </style>
  </head>
  <body class="govuk-template__body ">
    <script>document.body.className = ((document.body.className) ? document.body.className + ' js-enabled' : 'js-enabled');</script>

    <header class="govuk-header" role="banner" data-module="govuk-header">
      <div class="govuk-header__container govuk-width-container">
        <div class="govuk-header__logo">
          <a href="#" class="govuk-header__link govuk-header__link--homepage">
            <span class="govuk-header__logotype">
              <span class="govuk-header__logotype-text">
                Notify.pit
              </span>
            </span>
          </a>
        </div>
      </div>
    </header>

    <div class="govuk-width-container">
      <main class="govuk-main-wrapper" id="main-content" role="main">
        <h1 class="govuk-heading-xl">Notification Dashboard</h1>

        <div class="govuk-grid-row">
            <div class="govuk-grid-column-one-quarter">
                <div class="govuk-summary-card">
                    <div class="govuk-summary-card__title-wrapper">
                        <h2 class="govuk-summary-card__title">Total Sent</h2>
                    </div>
                    <div class="govuk-summary-card__content">
                        <p class="govuk-body govuk-!-font-size-48 govuk-!-font-weight-bold" id="total-count">
                            {{ notifications|length }}
                        </p>
                    </div>
                </div>
            </div>
            <div class="govuk-grid-column-three-quarters">
                 <p class="govuk-body">
                    <a href="/pit/notifications" class="govuk-link">View Raw JSON</a> |
                    <a href="/docs" class="govuk-link">API Docs</a>
                </p>
            </div>
        </div>

        <div class="filter-container">
          <div class="govuk-grid-row">
            <div class="govuk-grid-column-one-half">
              <div class="govuk-form-group">
                <label class="govuk-label" for="filter-date">
                  Filter by Date (UTC)
                </label>
                <div id="filter-date-hint" class="govuk-hint">
                  Select a specific date
                </div>
                <input class="govuk-input" id="filter-date" name="filter-date" type="date" aria-describedby="filter-date-hint" oninput="filterTable()">
              </div>
            </div>
            <div class="govuk-grid-column-one-half">
              <div class="govuk-form-group">
                <label class="govuk-label" for="filter-type">
                  Filter by Type
                </label>
                <div class="govuk-hint">
                  Select channel
                </div>
                <select class="govuk-select" id="filter-type" name="filter-type" onchange="filterTable()" style="width: 100%;">
                  <option value="all">All</option>
                  <option value="sms">SMS</option>
                  <option value="email">Email</option>
                  <option value="letter">Letter</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <table class="govuk-table" id="notifications-table">
          <caption class="govuk-table__caption govuk-table__caption--m">Recent Notifications</caption>
          <thead class="govuk-table__head">
            <tr class="govuk-table__row">
              <th scope="col" class="govuk-table__header" aria-sort="descending" data-column="0">
                <button onclick="sortTable(0)">Time (UTC)</button>
              </th>
              <th scope="col" class="govuk-table__header" aria-sort="none" data-column="1">
                <button onclick="sortTable(1)">Type</button>
              </th>
              <th scope="col" class="govuk-table__header" aria-sort="none" data-column="2">
                <button onclick="sortTable(2)">Recipient</button>
              </th>
              <th scope="col" class="govuk-table__header" aria-sort="none" data-column="3">
                <button onclick="sortTable(3)">Reference</button>
              </th>
              <th scope="col" class="govuk-table__header" aria-sort="none" data-column="4">
                <button onclick="sortTable(4)">ID</button>
              </th>
              <th scope="col" class="govuk-table__header">
                Actions
              </th>
            </tr>
          </thead>
          <tbody class="govuk-table__body">
            {% for n in notifications|reverse %}
            <tr class="govuk-table__row">
              <td class="govuk-table__cell">{{ n.created_at or 'N/A' }}</td>
              <td class="govuk-table__cell">
                  <strong class="govuk-tag {{ 'govuk-tag--blue' if n.type == 'email' else 'govuk-tag--green' }}">
                      {{ n.type }}
                  </strong>
              </td>
              <td class="govuk-table__cell">
                  {{ n.phone_number or n.email_address or n.personalisation.address_line_1 }}
              </td>
              <td class="govuk-table__cell">{{ n.reference or '-' }}</td>
              <td class="govuk-table__cell govuk-!-font-size-14">{{ n.id }}</td>
              <td class="govuk-table__cell">
                <a href="#" class="govuk-link" onclick="viewJson(event, '{{ n.id }}')">View JSON</a>
              </td>
            </tr>
            {% else %}
            <tr class="govuk-table__row" id="no-data-row">
                <td class="govuk-table__cell" colspan="6">No notifications received yet.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </main>
    </div>

    <dialog id="json-modal">
        <div class="modal-header">
            <h2 class="govuk-heading-m govuk-!-margin-bottom-0">Message Payload</h2>
            <button class="govuk-button govuk-button--secondary govuk-!-margin-bottom-0" onclick="closeModal()">Close</button>
        </div>
        <div class="modal-body">
            <pre id="json-content" class="json-view"></pre>
        </div>
    </dialog>

    <script>
      // Load raw data from backend
      const rawData = {{ notifications_json | safe }};

      function viewJson(e, id) {
        e.preventDefault();
        const record = rawData.find(r => r.id === id);
        if (record) {
            const jsonStr = JSON.stringify(record, null, 2);
            document.getElementById('json-content').textContent = jsonStr;
            document.getElementById('json-modal').showModal();
        }
      }

      function closeModal() {
        document.getElementById('json-modal').close();
      }

      function filterTable() {
        const dateInput = document.getElementById("filter-date").value.toLowerCase();
        const typeInput = document.getElementById("filter-type").value.toLowerCase();
        const table = document.getElementById("notifications-table");
        const tr = table.getElementsByTagName("tr");
        let visibleCount = 0;

        for (let i = 1; i < tr.length; i++) {
          const row = tr[i];
          if (row.id === "no-data-row") continue;

          const dateCell = row.getElementsByTagName("td")[0];
          const typeCell = row.getElementsByTagName("td")[1];

          if (dateCell && typeCell) {
            const dateText = dateCell.textContent || dateCell.innerText;
            const typeText = typeCell.textContent || typeCell.innerText;
            const dateMatch = dateText.toLowerCase().indexOf(dateInput) > -1;
            const typeMatch = (typeInput === "all") || (typeText.trim().toLowerCase() === typeInput);

            if (dateMatch && typeMatch) {
              row.style.display = "";
              visibleCount++;
            } else {
              row.style.display = "none";
            }
          }
        }
        document.getElementById("total-count").innerText = visibleCount;
      }

      function sortTable(columnIndex) {
        const table = document.getElementById("notifications-table");
        const tbody = table.querySelector("tbody");
        const rows = Array.from(tbody.querySelectorAll("tr")).filter(r => r.id !== "no-data-row");

        if (rows.length === 0) return;

        const header = table.querySelectorAll("th")[columnIndex];
        const currentSort = header.getAttribute("aria-sort");
        const newSort = currentSort === "ascending" ? "descending" : "ascending";

        table.querySelectorAll("th").forEach(th => th.setAttribute("aria-sort", "none"));
        header.setAttribute("aria-sort", newSort);

        rows.sort((rowA, rowB) => {
          const cellA = rowA.cells[columnIndex].innerText.trim().toLowerCase();
          const cellB = rowB.cells[columnIndex].innerText.trim().toLowerCase();

          if (cellA < cellB) return newSort === "ascending" ? -1 : 1;
          if (cellA > cellB) return newSort === "ascending" ? 1 : -1;
          return 0;
        });

        rows.forEach(row => tbody.appendChild(row));
      }
    </script>
  </body>
</html>